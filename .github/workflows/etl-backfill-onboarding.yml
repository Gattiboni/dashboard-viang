name: ETL Mercado Livre ‚Äî Backfill Onboarding

on:
  workflow_dispatch:

jobs:
  backfill-onboarding:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do reposit√≥rio
        run: |
          echo "[INFO] Iniciando checkout do reposit√≥rio"
          git clone https://github.com/${GITHUB_REPOSITORY}.git .
          echo "[INFO] Checkout conclu√≠do"

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üîé Verificar Python
        run: |
          echo "[INFO] Configurando ambiente Python"
          python --version || true
          echo "[INFO] Python configurado"

      - name: üì¶ Instalar depend√™ncias
        run: |
          echo "[INFO] Atualizando pip"
          python -m pip install --upgrade pip

          echo "[INFO] Instalando depend√™ncias do ETL"
          pip install requests psycopg2-binary python-dotenv

          echo "[INFO] Depend√™ncias instaladas com sucesso"

      - name: üöÄ Executar backfill onboarding Mercado Livre
        env:
          SUPABASE_DB_CONNECTION_STRING: ${{ secrets.SUPABASE_DB_CONNECTION_STRING }}
          SUPABASE_DB_SSL: ${{ secrets.SUPABASE_DB_SSL }}
          ML_APP_ID: ${{ secrets.ML_APP_ID }}
          ML_APP_SECRET: ${{ secrets.ML_APP_SECRET }}
        run: |
          echo "[INFO] ================================================"
          echo "[INFO] BACKFILL ONBOARDING ‚Äî IN√çCIO"
          echo "[INFO] Data/Hora UTC: $(date -u)"
          echo "[INFO] Reposit√≥rio: ${GITHUB_REPOSITORY}"
          echo "[INFO] Commit: ${GITHUB_SHA}"
          echo "[INFO] Branch: ${GITHUB_REF_NAME}"
          echo "[INFO] ================================================"

          echo "[INFO] Executando script backend/etl/ml_etl_backfill_onboarding.py"
          python backend/etl/ml_etl_backfill_onboarding.py

          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "[ERROR] Backfill onboarding terminou com erro (exit_code=$EXIT_CODE)"
            exit $EXIT_CODE
          fi

          echo "[INFO] ================================================"
          echo "[INFO] BACKFILL ONBOARDING ‚Äî FINALIZADO COM SUCESSO"
          echo "[INFO] Data/Hora UTC: $(date -u)"
          echo "[INFO] ================================================"
