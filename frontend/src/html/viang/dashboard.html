<!doctype html>
<html lang="pt-BR">
<!-- [Head] start -->

<head>
    @@include('../layouts/head-page-meta-root.html', { 'title': 'Dashboard Viang' })
    @@include('../layouts/head-css-root.html')
</head>
<!-- [Head] end -->

<!-- [Body] Start -->

<body @@bodySetup>
    @@include('../layouts/layout-vertical-viang.html')

    <!-- [ Main Content ] start -->
    <div class="pc-container">
        <div class="pc-content">
            @@include('../layouts/breadcrumb.html', {
            'breadcrumb-item': 'Dashboard',
            'breadcrumb-item-active': ''
            })

            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- Page Title (Dashboard Home) -->
                <div class="col-12">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="page-header-title">
                            <h5 class="mb-0">Visão geral</h5>
                        </div>

                        <div class="d-flex gap-2">
                            <select id="global-period-selector" class="form-select form-select-sm w-auto">
                                <option value="7d">Últimos 7 dias</option>
                                <option value="30d" selected>Últimos 30 dias</option>
                                <option value="90d">Últimos 90 dias</option>
                                <option value="custom">Período personalizado</option>
                            </select>
                        </div>
                    </div>
                </div>


                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Visão Geral</h5>
                            </div>
                            <div class="card-body">
                                <div class="card-body">

                                    <div id="dashboard-loader" class="d-flex justify-content-center align-items-center"
                                        style="min-height: 300px;">
                                        <div class="spinner-border text-primary"></div>
                                    </div>

                                    <div id="metabase-dashboard-container" class="d-none">
                                        <iframe id="metabase-dashboard-iframe" class="w-100"
                                            style="min-height: 600px; border: 0;" loading="lazy">
                                        </iframe>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [ Main Content ] end -->

                <script>
                    (function () {
                        const periodSelector = document.getElementById('global-period-selector');
                        const dashboardContainer = document.getElementById('metabase-dashboard-container');

                        if (!periodSelector || !dashboardContainer) return;

                        function formatDate(date) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        }

                        function calculatePeriod(value) {
                            const endDate = new Date();
                            let startDate = new Date();

                            switch (value) {
                                case '7d':
                                    startDate.setDate(endDate.getDate() - 7);
                                    break;
                                case '30d':
                                    startDate.setDate(endDate.getDate() - 30);
                                    break;
                                case '90d':
                                    startDate.setDate(endDate.getDate() - 90);
                                    break;
                                case 'custom':
                                    return null;
                                default:
                                    return null;
                            }

                            return {
                                start_date: formatDate(startDate),
                                end_date: formatDate(endDate)
                            };
                        }

                        function renderDashboardIframe(embedUrl) {
                            const iframe = document.getElementById('metabase-dashboard-iframe');
                            const loader = document.getElementById('dashboard-loader');
                            const container = document.getElementById('metabase-dashboard-container');

                            // garante estado inicial de carregamento (sem mexer em style e sem innerHTML)
                            loader.classList.remove('d-none');
                            container.classList.add('d-none');

                            iframe.onload = function () {
                                loader.classList.add('d-none');
                                container.classList.remove('d-none');
                            };

                            iframe.onerror = function () {
                                // sem innerHTML, sem alerta injetado; só remove o loader
                                loader.classList.add('d-none');
                            };

                            console.log('[DEBUG] embed_url recebido:', embedUrl);
                            console.log('[DEBUG] iframe antes:', iframe.src);

                            iframe.src = embedUrl;

                            console.log('[DEBUG] iframe depois:', iframe.src);

                        }


                        async function updateDashboard() {
                            const period = calculatePeriod(periodSelector.value);
                            if (!period) return;

                            window.VIANG_DASHBOARD_PERIOD = period;

                            try {
                                console.log('[Dashboard] Solicitando embed com período:', period);

                                const response = await fetch(
                                    'https://cbnisuoocsrhdqdpmips.supabase.co/functions/v1/metabase-embed-dashboard',
                                    {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNibmlzdW9vY3NyaGRxZHBtaXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5ODE5NDMsImV4cCI6MjA3ODU1Nzk0M30.j62UrKBalzn0lfASjaQdvSrKSUJLmFFPAFbFa_61l8U'
                                        },
                                        body: JSON.stringify({
                                            start_date: period.start_date,
                                            end_date: period.end_date
                                        })
                                    }
                                );

                                if (!response.ok) {
                                    throw new Error('Erro ao obter embed do dashboard');
                                }

                                const data = await response.json();

                                if (!data || !data.embed_url) {
                                    throw new Error('Resposta inválida do backend');
                                }

                                renderDashboardIframe(data.embed_url);
                            } catch (error) {
                                console.error('[Dashboard] Falha ao carregar dashboard:', error);

                                document.getElementById('dashboard-loader')?.classList.add('d-none');
                            }
                        }


                        periodSelector.addEventListener('change', updateDashboard);

                        // Inicialização
                        updateDashboard();
                    })();
                </script>


</body>
<!-- [Body] end -->

</html>