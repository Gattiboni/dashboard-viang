<!doctype html>
<html lang="pt-br">
<!-- [Head] start -->

<head>
    @@include('../layouts/head-page-meta-root.html', { 'title': 'Configurações' })
    @@include('../layouts/head-css-root.html')
</head>
<!-- [Head] end -->

<body @@bodySetup>
    <script>
        (function authGate() {
            const ACCESS_TOKEN = localStorage.getItem('sb_access_token');

            if (!ACCESS_TOKEN) {
                window.location.href = '/viang/login-viang.html';
            }
        })();
    </script>

    @@include('../layouts/layout-vertical-viang.html')

    <!-- [ Main Content ] start -->
    <section class="pc-container">
        <div class="pc-content">
            @@include('../layouts/breadcrumb.html', {
            'breadcrumb-item': 'Configurações',
            'breadcrumb-item-active': 'Geral'
            })

            <!-- [ Main Content ] start -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Usuários do Sistema</h5>
                        </div>

                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="users-table" class="table table-striped table-bordered nowrap">
                                    <thead>
                                        <tr>
                                            <th>Usuário</th>
                                            <th>Nível de Permissão</th>
                                            <th>Status</th>
                                            <th>E-mail de acesso</th>
                                            <th>Master</th>
                                            <th>Criado em</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- preenchido via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </section>
    <!-- [ Main Content ] end -->
    <script>
        /* =====================================================
         *  CONFIG
         * ===================================================== */
        const SUPABASE_FN_BASE = 'https://cbnisuoocsrhdqdpmips.supabase.co/functions/v1/users-config';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNibmlzdW9vY3NyaGRxZHBtaXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5ODE5NDMsImV4cCI6MjA3ODU1Nzk0M30.j62UrKBalzn0lfASjaQdvSrKSUJLmFFPAFbFa_61l8U';
    </script>


    <script>
        /* =====================================================
         *  CONFIG — USERS (MVP CONSULTIVO)
         * ===================================================== */

        (async function loadUsersConfig() {
            try {
                const res = await fetch(`${SUPABASE_FN_BASE}/list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }

                const data = await res.json();
                const tbody = document.querySelector('#users-table tbody');
                if (!tbody) return;

                tbody.innerHTML = '';

                data.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${user.email}</td>
                <td>${user.role} (${user.permission_level})</td>
                <td>${user.status}</td>
                <td>${user.email}</td>
                <td>${user.is_master ? 'Sim' : 'Não'}</td>
                <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
            `;
                    tbody.appendChild(tr);
                });

                data.forEach(user => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.role} (${user.permission_level})</td>
                        <td>${user.status}</td>
                        <td>${user.email}</td>
                        <td>${user.is_master ? 'Sim' : 'Não'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
                    `;

                    tbody.appendChild(tr);
                });


            } catch (err) {
                console.error('[Config][Users]', err);
            }
        })();
    </script>

    <!-- Fale com o Dev — Modal Global -->
    @@include('../layouts/falecomdev.html')

    <!-- v.I.A.ng Modal (GLOBAL, UMA VEZ POR PÁGINA) -->
    @@include('../layouts/viang-ai.html')

    @@include('../layouts/footer-js-root-viang.html')

</body>
<!-- [Body] end -->

</html>